App.addChild("MoipForm",{el:"form.moip",getMoipToken:function(t){var e=this;$("#MoipWidget").length>0?_.isFunction(t)&&t():$.post("/payment/moip/"+this.contributionId+"/get_moip_token").success(function(a){e.paymentChoice.$("input").attr("disabled","disabled"),"fail"==a.get_token_response.status?e.checkoutFailure({Code:0,Mensagem:a.get_token_response.message}):(e.createMoipWidget(a),_.isFunction(t)&&t(a))})},createMoipWidget:function(t){widget_tag=$("<div/>").attr({id:t.widget_tag.tag_id,"data-token":t.widget_tag.token,"callback-method-success":t.widget_tag.callback_success,"callback-method-error":t.widget_tag.callback_error}),$("#catarse_moip_form").prepend(widget_tag)},checkoutFailure:function(t){this.loader.hide();var e=t.length>0?t[0]:t;914==e.Codigo&&(e.Mensagem+='. Tente <a href="javascript:window.location.reload();">recarregar a p\xe1gina</a> e repetir a opera\xe7\xe3o de pagamento.'),this.message.find("p").html(e.Mensagem),this.message.fadeIn("fast"),$('input[type="submit"]').removeAttr("disabled").show()},checkoutSuccessful:function(t){var e=this;$.post("/payment/moip/"+this.contributionId+"/moip_response",{response:t}).success(function(){if(e.loader.hide(),"Cancelado"==t.Status)return e.checkoutFailure({Codigo:0,Mensagem:t.Classificacao.Descricao+". Verifique os dados de pagamento e tente novamente."});if(t.url&&"block"!=$("#payment_type_cards_section").css("display")){var a=$('<a target="__blank">'+t.url+"</a>");a.attr("href",t.url),$(".link_content:visible").empty().html(a),$(".payment_section:visible .subtitle").fadeIn("fast")}else{var n=$("#project_review").data("thank-you-path");location.href=n?n:"/"}})},activate:function(){this.message=this.$(".next_step_after_valid_document .alert-danger"),this.contributionId=$("input#contribution_id").val(),this.projectId=$("input#project_id").val(),this.loader=this.$(".loader"),window.checkoutSuccessful=_.bind(this.checkoutSuccessful,this),window.checkoutFailure=_.bind(this.checkoutFailure,this)}}),App.views.MoipForm.UserDocument={onContentClick:function(){window.setTimeout(function(){app.moipForm.checkoutSuccessful({StatusPagamento:"Success"})},2e3)},onUserDocumentKeyup:function(t){var e=$(t.currentTarget),a=e.val();e.prop("maxlength",18);var n=this.validateCpf(a),i=this.validateCnpj(a.replace(/[\/.\-\_ ]/g,"")),o=a.replace(/[.\-\_ ]/g,"").length;o>10?("payment_card_cpf"!=e.attr("id")&&(11==o?e.mask("999.999.999-99?999"):14==o&&e.mask("99.999.999/9999-99"),(14!=o||11!=o)&&e.unmask()),n||i?(e.addClass("ok").removeClass("error"),$.ajax({url:"/projects/"+this.moipForm.projectId+"/contributions/"+this.moipForm.contributionId,type:"PUT",data:{contribution:{payer_document:a}}})):e.addClass("error").removeClass("ok")):e.addClass("error").removeClass("ok")},validateCpf:function(t){var e,a,n=0;t=t.replace(/[.\-\_ ]/g,"");var i=Math.floor(parseFloat(t)/100),o=100*i;for(e=0;8>=e;e++)n+=i%10*(e+2),i=Math.floor(i/10);for(a=2>n%11?0:11-n%11,o+=10*a,n=0,i=Math.floor(o/10),e=0;9>=e;e++)n+=i%10*(e+2),i=Math.floor(i/10);return a=2>n%11?0:11-n%11,o+=a,parseFloat(t)===o},validateCnpj:function(t){var e,a,n,i,o,r,c,s;if(s=1,t.length<14&&t.length<15)return!1;for(i=0;i<t.length-1;i++)if(t.charAt(i)!=t.charAt(i+1)){s=0;break}if(s)return!1;for(c=t.length-2,e=t.substring(0,c),a=t.substring(c),n=0,r=c-7,i=c;i>=1;i--)n+=e.charAt(c-i)*r--,2>r&&(r=9);if(o=2>n%11?0:11-n%11,o!=a.charAt(0))return!1;for(c+=1,e=t.substring(0,c),n=0,r=c-7,i=c;i>=1;i--)n+=e.charAt(c-i)*r--,2>r&&(r=9);return o=2>n%11?0:11-n%11,o!=a.charAt(1)?!1:!0}},App.views.MoipForm.addChild("PaymentAccount",_.extend({el:"#payment_type_account_section",events:{"change select#account":"onChangeAccount","click input#build_account_link":"onBuildAccountClick","keyup #user_document_account":"onUserDocumentKeyup","click .link_content a":"onContentClick"},activate:function(){this.moipForm=this.parent,this.$("input#user_document_account").mask("999.999.999-99")},onChangeAccount:function(t){var e=$(t.currentTarget).val();this.$("input#build_account_link").attr("disabled",!(""!=e&&void 0!=e))},onBuildAccountClick:function(t){var e=this;t.preventDefault(),$(t.currentTarget).hide(),e.moipForm.loader.show(),e.moipForm.getMoipToken(function(){var t={Instituicao:$("select#account").val(),Forma:"DebitoBancario"};MoipWidget(t)})}},App.views.MoipForm.UserDocument)),App.views.MoipForm.addChild("PaymentCard",_.extend({el:"#payment_type_cards_section",events:{'keyup input[type="text"]':"creditCardInputValidator","keyup #payment_card_number":"onKeyupPaymentCardNumber","click input#credit_card_submit":"onSubmit","keyup #payment_card_cpf":"onUserDocumentKeyup"},activate:function(){this.moipForm=this.parent,this.$("input#payment_card_date").mask("99/99"),this.$("input#payment_card_birth").mask("99/99/9999"),this.$("input#payment_card_cpf").mask("999.999.999-99"),this.$("input#payment_card_phone").mask("(99) 9999-9999?9")},onKeyupPaymentCardNumber:function(t){this.$("input#payment_card_flag").val(this.getCardFlag($(t.currentTarget).val()))},onSubmit:function(t){var e=this;t.preventDefault(),$(t.currentTarget).hide(),e.moipForm.loader.show(),e.moipForm.getMoipToken(function(){var t={Forma:"CartaoCredito",Instituicao:e.$("input#payment_card_flag").val(),Parcelas:"1",Recebimento:"AVista",CartaoCredito:{Numero:e.$("input#payment_card_number").val(),Expiracao:e.$("input#payment_card_date").val(),CodigoSeguranca:e.$("input#payment_card_source").val(),Portador:{Nome:e.$("input#payment_card_name").val(),DataNascimento:e.$("input#payment_card_birth").val(),Telefone:e.$("input#payment_card_phone").val(),Identidade:e.$("input#payment_card_cpf").val()}}};MoipWidget(t)})},hasContent:function(t){var e=$(t).val().replace(/[\-\.\_\/\s]/g,"");return e&&e.length>0?($(t).addClass("ok").removeClass("error"),!0):($(t).addClass("error").removeClass("ok"),!1)},creditCardInputValidator:function(){var t=this,e=!0;$.each($('#payment_type_cards_section input[type="text"]'),function(a,n){e=t.hasContent(n)}),$("input#credit_card_submit").attr("disabled",!e)},getCardFlag:function(t){var e=(t+"").replace(/\s/g,"");return/^(34|37)/.test(e)&&15==e.length?"AmericanExpress":/^(51|52|53|54|55)/.test(e)&&16==e.length?"Mastercard":!/^(4)/.test(e)||13!=e.length&&16!=e.length?/^(300|301|302|303|304|305|36|38)/.test(e)&&14==e.length?"Diners":/^(38)/.test(e)&&19==e.length?"Hipercard":"Desconhecido":"Visa"}},App.views.MoipForm.UserDocument)),App.views.MoipForm.addChild("PaymentChoice",{el:".list_payment",events:{'change input[type="radio"]':"onListPaymentChange"},onListPaymentChange:function(t){$(".payment_section").fadeOut("fast",function(){var e=$(t.currentTarget).attr("id");$("#"+e+"_section").fadeIn("fast")})},activate:function(){this.$("input#payment_type_cards").click()}}),App.views.MoipForm.addChild("PaymentSlip",_.extend({el:"#payment_type_boleto_section",events:{"click input#build_boleto":"onBuildBoletoClick","click .link_content a":"onContentClick","keyup #user_document_payment_slip":"onUserDocumentPaymentSlipKeyup"},onUserDocumentPaymentSlipKeyup:function(t){var e=$(t.currentTarget);this.onUserDocumentKeyup(t),$("input#build_boleto").attr("disabled",!e.hasClass("ok"))},activate:function(){this.moipForm=this.parent,this.$("input#user_document_payment_slip").mask("999.999.999-99")},onBuildBoletoClick:function(t){var e=this;t.preventDefault(),$(t.currentTarget).hide(),e.moipForm.loader.show(),e.moipForm.getMoipToken(function(){var t={Forma:"BoletoBancario"};MoipWidget(t)})}},App.views.MoipForm.UserDocument)),$(function(){app.createViewGetters()});